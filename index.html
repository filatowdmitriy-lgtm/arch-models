<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Архитектурные детали — 3D Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overscroll-behavior: none;
    }

    body {
      margin: 0;
      background: #050506;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }

    .app-root {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
    }

    /* ---------- TOP BAR ---------- */
    .app-header {
      padding: 10px 16px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      background: #050506;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      z-index: 20;
      flex-shrink: 0;
    }

    .app-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #bbbbbb;
    }

    .app-subtitle {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    /* ---------- MAIN LAYOUT ---------- */
    .app-main {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
    }

    /* ---------- ГАЛЕРЕЯ ---------- */
    .gallery {
      position: absolute;
      inset: 0;
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px;
      background: radial-gradient(ellipse at top, #14141a 0%, #050506 55%);
      z-index: 15;
      opacity: 1;
      pointer-events: auto;
      transition: opacity 0.3s ease;
      align-content: flex-start;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 640px) {
      .gallery {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .gallery.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .model-card {
      background: linear-gradient(145deg, #181820, #101018);
      border-radius: 14px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.04);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      height: auto;
    }

    .model-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      border-color: rgba(255, 255, 255, 0.16);
    }

    .model-thumb {
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 0%, #2c2c38 0%, #14141f 35%, #050506 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.2);
      font-size: 40px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .model-caption {
      font-size: 15px;
      font-weight: 600;
      color: #f3f3f3;
    }

    .model-desc {
      font-size: 13px;
      color: #a4a4aa;
      line-height: 1.3;
    }

    /* ---------- VIEWER AREA ---------- */
    .viewer-wrapper {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .viewer-wrapper.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .viewer-toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 30;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .btn {
      background: rgba(0, 0, 0, 0.6);
      color: #f5f5f5;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      user-select: none;
      backdrop-filter: blur(4px);
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .model-label {
      font-size: 13px;
      color: #b7b7c0;
      max-width: 220px;
    }

    .viewer-main {
      position: absolute;
      inset: 0;
      touch-action: none;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* ---------- LOADING OVERLAY ---------- */
    #loading {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: radial-gradient(circle at top, rgba(0,0,0,0.85), rgba(0,0,0,0.96));
      z-index: 40;
    }

    .loader-ring {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: 3px solid rgba(255, 255, 255, 0.08);
      border-top-color: #ffffff;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #loadingText {
      margin-top: 12px;
      font-size: 13px;
      color: #e0e0e0;
    }

    .loading-bar {
      margin-top: 10px;
      width: 140px;
      height: 3px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      overflow: hidden;
    }

    .loading-bar-inner {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ffffff, #8888ff);
      border-radius: inherit;
      transition: width 0.15s ease;
    }

    /* ---------- STATUS ---------- */
    #status {
      position: absolute;
      left: 12px;
      bottom: 10px;
      font-size: 11px;
      color: #7f7f86;
      z-index: 50;
      opacity: 0.9;
    }
  </style>

  <!-- importmap -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.153.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.153.0/examples/jsm/"
    }
  }
  </script>

  <!-- Telegram Mini App: готовность и auto-expand (без ошибок вне Telegram) -->
  <script>
    (function () {
      if (window.Telegram && Telegram.WebApp) {
        try {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        } catch (e) {}
      }
    })();
  </script>
</head>
<body>
<div class="app-root">
  <header class="app-header">
    <div>
      <div class="app-title">АРХИТЕКТУРНЫЕ ДЕТАЛИ</div>
      <div class="app-subtitle">Крути-Верти</div>
    </div>
  </header>

  <main class="app-main">
    <!-- ГАЛЕРЕЯ -->
    <div class="gallery" id="gallery"></div>

    <!-- ВЬЮЕР -->
    <div class="viewer-wrapper" id="viewerWrapper">
      <div class="viewer-toolbar">
        <button class="btn" id="backBtn">← Галерея</button>
        <button class="btn" id="prevBtn">← Предыдущая</button>
        <button class="btn" id="nextBtn">Следующая →</button>
        <div class="model-label" id="modelLabel"></div>
      </div>

      <div class="viewer-main">
        <canvas id="canvas"></canvas>
      </div>

      <!-- LOADING OVERLAY -->
      <div id="loading">
        <div class="loader-ring"></div>
        <div id="loadingText">Загрузка...</div>
        <div class="loading-bar">
          <div class="loading-bar-inner" id="progressBar"></div>
        </div>
      </div>

      <div id="status"></div>
    </div>
  </main>
</div>

<script type="module">
  import * as THREE from "three";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  /* ===============================
     МОДЕЛИ ДЛЯ ГАЛЕРЕИ
  =============================== */
  const MODELS = [
    {
      id: "dorichescaya",
      name: "Дорическая капитель",
      desc: "Архаический строгий стиль.",
      url: "https://filatowdmitriy-lgtm.github.io/arch-models/dorichescaya.glb",
      thumbLetter: "D"
    },
    {
      id: "ionic",
      name: "Ионическая капитель",
      desc: "Классический греческий ордер, витые волюты.",
      url: "https://filatowdmitriy-lgtm.github.io/arch-models/ionic.glb",
      thumbLetter: "I"
    }
  ];

  /* ===============================
     DOM ЭЛЕМЕНТЫ
  =============================== */
  const galleryEl      = document.getElementById("gallery");
  const viewerWrapper  = document.getElementById("viewerWrapper");
  const backBtn        = document.getElementById("backBtn");
  const prevBtn        = document.getElementById("prevBtn");
  const nextBtn        = document.getElementById("nextBtn");
  const modelLabelEl   = document.getElementById("modelLabel");
  const loadingEl      = document.getElementById("loading");
  const loadingTextEl  = document.getElementById("loadingText");
  const progressBarEl  = document.getElementById("progressBar");
  const statusEl       = document.getElementById("status");
  const canvas         = document.getElementById("canvas");

  let scene, camera, renderer;
  let currentModel = null;
  let currentModelId = null;

  /* ===============================
     КЭШ МОДЕЛЕЙ
  =============================== */
  const cache = {};

  /* ===============================
     СОСТОЯНИЕ КАМЕРЫ
     — фронтальный ракурс
     — лёгкий подъём (rotX)
  =============================== */
  const state = {
    radius: 4.5,
    minRadius: 2.0,
    maxRadius: 12.0,
    rotX: 0.10,       // фронтальный вид — слегка сверху
    rotY: 0.00,       // строго по центру
    targetRotX: 0.10,
    targetRotY: 0.00
  };

  /* ===============================
     ИНИЦИАЛИЗАЦИЯ THREE.JS
  =============================== */
  initThree();
  buildGallery();
  showGallery();

  function initThree() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050506);

    /* ---------- КАМЕРА ---------- */
    camera = new THREE.PerspectiveCamera(
      40,
      window.innerWidth / window.innerHeight,
      0.1,
      50
    );
    updateCameraPosition();

    /* ---------- РЕНДЕРЕР ---------- */
    renderer = new THREE.WebGLRenderer({
      canvas,
      antialias: true,
      alpha: false
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.BasicShadowMap;

    /* ---------- СТУДИЙНОЕ ОСВЕЩЕНИЕ ---------- */


    // 1) Верхний мягкий полутон — чуть холодный
    const zenith = new THREE.DirectionalLight(0xf5f8ff, 0.0);
    zenith.position.set(0, 11, 2);
    scene.add(zenith);

    // 2) Главный KEY — тёплый, мощный, выразительный
    const key = new THREE.DirectionalLight(0xffc4a0, 1.85);
    key.position.set(5.5, 6.0, 3.5);
    key.castShadow = false;  // можно включить, если хочешь сильные тени
    scene.add(key);

    // 3) Глубокий холодный SHADOW FILL (минимальный)
    const fill = new THREE.DirectionalLight(0xcad8ff, 0.35);
    fill.position.set(-7, 3.5, 2);
    scene.add(fill);

    // 4) Главный RIM — белый, сильный, даёт “подсветку контура”
    const rim = new THREE.DirectionalLight(0xffffff, 0.5);
    rim.position.set(-3.5, 5, -7.5);
    scene.add(rim);

    // 5) Второй rim (очень холодный, узкий)
    const rimCold = new THREE.DirectionalLight(0xd8e4ff, 0.1);
    rimCold.position.set(2.5, 3.5, -5);
    scene.add(rimCold);

    // 7) Ambient — минимальный, почти незаметный
    const ambient = new THREE.AmbientLight(0xffffff, 0.04);
    scene.add(ambient);

    // 8) Hemisphere — микро-подсветка, создаёт “ореол”
    const hemi = new THREE.HemisphereLight(0xffffff, 0x0a0a0a, 0.07);
    scene.add(hemi);


    

   

    /* ---------- АДАПТАЦИЯ ПРИ РЕЗАЙЗЕ ---------- */
    window.addEventListener("resize", onWindowResize);

    /* ---------- УПРАВЛЕНИЕ (ОРБИТЫ) ---------- */
    initControls();

    /* ---------- ГЛАВНЫЙ РЕНДЕР-ЦИКЛ ---------- */
    renderer.setAnimationLoop(() => {
      state.rotX += (state.targetRotX - state.rotX) * 0.22;
      state.rotY += (state.targetRotY - state.rotY) * 0.22; 

      updateCameraPosition();
      renderer.render(scene, camera);
    });
  }

  /* ===============================
     ПЕРЕСЧЁТ ПОЗИЦИИ КАМЕРЫ
  =============================== */
  function updateCameraPosition() {
    const r = state.radius;
    const x = r * Math.sin(state.rotY) * Math.cos(state.rotX);
    const z = r * Math.cos(state.rotY) * Math.cos(state.rotX);
    const y = r * Math.sin(state.rotX);

    camera.position.set(x, y, z);
    camera.lookAt(0, 0, 0);
  }

  /* ===============================
     РЕАКЦИЯ НА РЕЗАЙЗ
  =============================== */
  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  /* ===============================
     УПРАВЛЕНИЕ МЫШЬЮ + ТАЧЕМ
  =============================== */
  function initControls() {
    let isDragging = false;
    let lastX = 0, lastY = 0;
    let touchMode = null;
    let lastPinchDist = 0;

    /* ----- МЫШЬ ----- */
    canvas.addEventListener("mousedown", (e) => {
      isDragging = true;
      lastX = e.clientX;
      lastY = e.clientY;
    });

    window.addEventListener("mouseup", () => {
      isDragging = false;
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;

      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;

      lastX = e.clientX;
      lastY = e.clientY;

      state.targetRotY += dx * -0.005;
      state.targetRotX += dy * 0.005;

      state.targetRotX = Math.max(
        -Math.PI / 2 + 0.2,
        Math.min(Math.PI / 2 - 0.2, state.targetRotX)
      );
    });

    /* ----- ЗУМ КОЛЕСОМ ----- */
    canvas.addEventListener("wheel", (e) => {
      e.preventDefault();
      const delta = e.deltaY * 0.002;

      state.radius = THREE.MathUtils.clamp(
        state.radius + delta,
        state.minRadius,
        state.maxRadius
      );
    }, { passive: false });

    /* ----- ТАЧ УПРАВЛЕНИЕ ----- */
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      if (e.touches.length === 1) {
        touchMode = "rotate";
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      } else if (e.touches.length === 2) {
        touchMode = "zoom";
        lastPinchDist = pinchDistance(e.touches[0], e.touches[1]);
      }
    }, { passive: false });

    canvas.addEventListener("touchmove", (e) => {
      if (!touchMode) return;
      e.preventDefault();

      if (touchMode === "rotate" && e.touches.length === 1) {
        const t = e.touches[0];
        const dx = t.clientX - lastX;
        const dy = t.clientY - lastY;

        lastX = t.clientX;
        lastY = t.clientY;

        state.targetRotY += dx * -0.008;
        state.targetRotX += dy * 0.008;

        state.targetRotX = Math.max(
          -Math.PI / 2 + 0.2,
          Math.min(Math.PI / 2 - 0.2, state.targetRotX)
        );
      } else if (touchMode === "zoom" && e.touches.length === 2) {
        const dist = pinchDistance(e.touches[0], e.touches[1]);
        const delta = (lastPinchDist - dist) * 0.01;

        lastPinchDist = dist;

        state.radius = THREE.MathUtils.clamp(
          state.radius + delta,
          state.minRadius,
          state.maxRadius
        );
      }
    }, { passive: false });

    window.addEventListener("touchend", () => {
      touchMode = null;
    });

    function pinchDistance(t1, t2) {
      const dx = t1.clientX - t2.clientX;
      const dy = t1.clientY - t2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
  }

  /* ===============================
     ГАЛЕРЕЯ
  =============================== */
  function buildGallery() {
    galleryEl.innerHTML = "";

    MODELS.forEach((m) => {
      const card = document.createElement("div");
      card.className = "model-card";
      card.dataset.model = m.id;

      const thumb = document.createElement("div");
      thumb.className = "model-thumb";
      thumb.textContent = m.thumbLetter || m.name.charAt(0);

      const caption = document.createElement("div");
      caption.className = "model-caption";
      caption.textContent = m.name;

      const desc = document.createElement("div");
      desc.className = "model-desc";
      desc.textContent = m.desc;

      card.appendChild(thumb);
      card.appendChild(caption);
      card.appendChild(desc);

      card.addEventListener("click", () => {
        openViewerForModel(m.id);
      });

      galleryEl.appendChild(card);
    });
  }

  function showGallery() {
    galleryEl.classList.remove("hidden");
    viewerWrapper.classList.remove("visible");
    setStatus("");
  }

  function openViewerForModel(modelId) {
    const m = MODELS.find((x) => x.id === modelId);
    if (!m) return;

    modelLabelEl.textContent = m.name;

    galleryEl.classList.add("hidden");
    viewerWrapper.classList.add("visible");

    loadModel(modelId);
  }

  function getModelIndex(id) {
    return MODELS.findIndex((m) => m.id === id);
  }

  backBtn.addEventListener("click", showGallery);

  nextBtn.addEventListener("click", () => {
    if (!currentModelId) {
      openViewerForModel(MODELS[0].id);
      return;
    }
    let idx = getModelIndex(currentModelId);
    idx = (idx + 1) % MODELS.length;
    openViewerForModel(MODELS[idx].id);
  });

  prevBtn.addEventListener("click", () => {
    if (!currentModelId) {
      openViewerForModel(MODELS[0].id);
      return;
    }
    let idx = getModelIndex(currentModelId);
    idx = (idx - 1 + MODELS.length) % MODELS.length;
    openViewerForModel(MODELS[idx].id);
  });

  /* ===============================
     ЗАГРУЗКА МОДЕЛИ (pivot + кэш)
  =============================== */
  function loadModel(modelId) {
    const m = MODELS.find((x) => x.id === modelId);
    if (!m) return;

    currentModelId = modelId;
    showLoading("Загрузка…", 0);
    setStatus("Загрузка: " + m.name);

    /* --- КЭШ --- */
    if (cache[m.id]) {
      const clone = cache[m.id].clone(true);
      setModel(clone);
      hideLoading();
      setStatus("Модель из кэша: " + m.name);
      return;
    }

    /* --- ЗАГРУЗЧИК --- */
    const loader = new GLTFLoader();

    loader.load(
      m.url,
      (gltf) => {
        const root = new THREE.Group();
        root.add(gltf.scene);

        /* ---------- PIVOT ---------- */
        const box = new THREE.Box3().setFromObject(root);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        // смещаем модель в (0,0,0)
        gltf.scene.position.sub(center);

        /* ---------- МАСШТАБ ---------- */
        const maxSize = Math.max(size.x, size.y, size.z);
        if (maxSize > 0) {
          const base = 2.0;               // целевой визуальный размер
          const scale = base / maxSize;
          root.scale.setScalar(scale);

          // пересчёт bounding sphere после масштаба
          const box2 = new THREE.Box3().setFromObject(root);
          const sphere = box2.getBoundingSphere(new THREE.Sphere());
          const baseRadius = sphere.radius || base;

// ---------- ИДЕАЛЬНАЯ АВТО-КАМЕРА ПО SPHERE-RADIUS ----------
const fovRad = camera.fov * Math.PI / 180;

// центр и радиус
const sphereRadius = baseRadius;

// расстояние: полностью помещает сферу в кадр
let dist = sphereRadius / Math.sin(fovRad / 2);

// Определяем мобильное устройство
const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);

// Разный множитель камеры
const distanceFactor = isMobile ? 1.55 : 1;

// немного воздуха
dist *= distanceFactor;
state.radius = dist;
state.targetRadius = dist;

// применяем
state.minRadius = dist * 0.4;
state.maxRadius = dist * 6.0;
        }

        /* ---------- МАТЕРИАЛ «ГИПС» ---------- */
        applyPlasterMaterial(root);

        /* ---------- КЭШИРУЕМ ---------- */
        cache[m.id] = root.clone(true);

        /* ---------- ПОКАЗЫВАЕМ МОДЕЛЬ ---------- */
        setModel(root);

        hideLoading();
        setStatus("Модель загружена: " + m.name);
      },

      /* --- ПРОГРЕСС --- */
      (xhr) => {
        if (xhr.lengthComputable) {
          const percent = (xhr.loaded / xhr.total) * 100;
          showLoading("Загрузка: " + percent.toFixed(0) + "%", percent);
        } else {
          showLoading("Загрузка…", null);
        }
      },

      /* --- ОШИБКА --- */
      (err) => {
        console.error("Ошибка загрузки модели:", err);
        hideLoading();
        setStatus("Ошибка загрузки модели");
        alert("Ошибка загрузки модели.");
      }
    );
  }

  /* ===============================
     УСТАНОВКА МОДЕЛИ В СЦЕНУ
  =============================== */
  function setModel(root) {
    if (currentModel) {
      scene.remove(currentModel);
    }
    currentModel = root;
    scene.add(currentModel);

    // фронтальный ракурс
    state.targetRotX = 0.10;
    state.targetRotY = 0.00;
  }

  /* ===============================
     МАТЕРИАЛ — «ГИПС»
  =============================== */
  function applyPlasterMaterial(root) {
    const plaster = new THREE.MeshPhysicalMaterial({
      color: 0xf5f5f5,
      roughness: 0.8,
      metalness: 0.0,
      sheen: 0.1,
      clearcoat: 0.05
    });

    root.traverse((obj) => {
      if (obj.isMesh) {
        obj.material = plaster;
        obj.castShadow = true;
        obj.receiveShadow = true;
      }
    });
  }

  /* ===============================
     LOADING UI
  =============================== */
  function showLoading(text, percent) {
    loadingEl.style.display = "flex";
    loadingTextEl.textContent = text;
    if (typeof percent === "number") {
      progressBarEl.style.width = percent.toFixed(0) + "%";
    } else {
      progressBarEl.style.width = "15%";
    }
  }

  function hideLoading() {
    loadingEl.style.display = "none";
  }

  function setStatus(text) {
    statusEl.textContent = text || "";
  }

  // Глобально блокируем прокрутку страницы,
  // когда открыт вьюер (актуально для Mini App)
  document.addEventListener(
    "touchmove",
    (e) => {
      if (viewerWrapper.classList.contains("visible")) {
        e.preventDefault();
      }
    },
    { passive: false }
  );
</script>
</body>
</html>
