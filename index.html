<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Архитектурные детали — Viewer (r153)</title>
    <style>
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:#0f0f10;color:#eee;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
        #container{display:flex;flex-direction:column;height:100vh;}
        #sidebar{background:#151515;color:#fff;padding:18px;border-bottom:1px solid #222;flex-shrink:0}
        #sidebar h2{font-size:18px;margin-bottom:12px}
        .model-list{display:flex;gap:10px;overflow:auto;padding-bottom:6px}
        .model-item{background:linear-gradient(180deg,#202024,#151518);padding:10px 12px;border-radius:8px;border:1px solid #2b2b2f;cursor:pointer;white-space:nowrap;flex-shrink:0;min-width:160px}
        .model-item.active{outline:2px solid rgba(255,255,255,0.06);box-shadow:0 6px 18px rgba(0,0,0,0.6)}
        #info{margin-top:14px;font-size:13px;line-height:1.35;opacity:0.95}
        #info h1{font-size:18px;margin:0 0 8px 0}
        #info .meta{opacity:0.8;font-size:13px;margin-bottom:8px}
        #viewer{flex:1;position:relative;display:block;overflow:hidden}
        canvas{display:block;width:100%;height:100%}
        #loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(10,10,10,0.6);padding:14px 18px;border-radius:12px;border:1px solid #333;backdrop-filter:blur(6px);display:flex;align-items:center;gap:12px}
        .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,0.08);border-top-color:#fff;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .progress{height:6px;background:#222;border-radius:6px;overflow:hidden;min-width:140px}
        .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#8ab4ff,#5de0a3)}
        .controls-info{position:absolute;left:12px;bottom:12px;padding:8px 12px;border-radius:10px;background:rgba(8,8,8,0.5);border:1px solid rgba(255,255,255,0.03);font-size:13px}
        .mobile-controls{position:absolute;right:12px;bottom:18px;display:flex;gap:8px}
        .control-btn{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff}
        @media(min-width:780px){
            #container{flex-direction:row}
            #sidebar{width:320px;height:100vh;border-right:1px solid #171717;border-bottom:none;overflow:auto}
            .model-list{flex-direction:column}
            .model-item{min-width:unset;width:100%}
        }
    </style>
</head>
<body>
<div id="container">
    <div id="sidebar">
        <h2>Архитектурные детали</h2>
        <div class="model-list">
            <div class="model-item active" data-model="dorichescaya">Дорическая капитель</div>
            <div class="model-item" data-model="ionic">Ионическая капитель</div>
        </div>
        <div id="info">
            <h1 id="model-title">Дорическая капитель</h1>
            <div class="meta" id="model-style">Архитектурный стиль: Дорический ордер</div>
            <div class="meta" id="model-period">Исторический период: VII–V века до н. э.</div>
            <p id="model-description">Дорическая капитель — самая строгая и простая из классических.</p>
        </div>
    </div>

    <div id="viewer">
        <canvas id="canvas"></canvas>

        <div id="loading">
            <div class="spinner" aria-hidden="true"></div>
            <div style="display:flex;flex-direction:column">
                <div id="loadingText">Загрузка...</div>
                <div class="progress" style="margin-top:8px"><i id="progressBar"></i></div>
            </div>
        </div>

        <div class="controls-info">
            <span class="desktop-info">ЛКМ: вращать • ПКМ: перемещать • Колесико: масштаб</span>
            <span class="mobile-info" style="display:none">Один палец: вращать • Два пальца: масштаб</span>
        </div>

        <div class="mobile-controls" id="mobileControls" style="display:none">
            <button class="control-btn" id="zoomIn">+</button>
            <button class="control-btn" id="zoomOut">−</button>
            <button class="control-btn" id="resetView">⟳</button>
        </div>
    </div>
</div>

<!-- Three.js r153 + GLTFLoader as module -->
<script type="module">

import * as THREE from "https://unpkg.com/three@0.153.0/build/three.module.js";
import { GLTFLoader } from "https://unpkg.com/three@0.153.0/examples/jsm/loaders/GLTFLoader.js";

const modelInfo = {
    'ionic': {
        title: "Ионическая капитель",
        style: "Архитектурный стиль: Ионический ордер",
        period: "Исторический период: VI–V века до н. э.",
        description: "Ионическая капитель отличается волютами."
    },
    'dorichescaya': {
        title: "Дорическая капитель",
        style: "Архитектурный стиль: Дорический ордер",
        period: "Исторический период: VII–V века до н. э.",
        description: "Дорическая капитель — строгая и массивная."
    }
};

const modelUrls = {
    'dorichescaya': 'https://raw.githubusercontent.com/filatowdmitriy-lgtm/arch-models/main/dorichescaya.glb',
    'ionic': 'https://raw.githubusercontent.com/filatowdmitriy-lgtm/arch-models/main/ionic.glb'
};

class ModelViewer {
    constructor() {
        this.currentModel = null;
        this.rotation = { x: 0, y: 0 };
        this.targetRotation = { x: 0, y: 0 };
        this.cameraDistance = 5;
        this.minCameraDistance = 2;
        this.maxCameraDistance = 20;
        this.mouse = { down: false, button: 0, x: 0, y: 0 };
        this.touch = { isScaling: false };
        this.isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        this.init();
    }

    init() {
        const viewer = document.getElementById("viewer");

        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x0f0f10);

        this.camera = new THREE.PerspectiveCamera(
            45,
            viewer.clientWidth / viewer.clientHeight,
            0.01,
            2000
        );
        this.updateCameraPosition();

        this.renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById('canvas'),
            antialias: true,
            alpha: false
        });
        this.renderer.setSize(viewer.clientWidth, viewer.clientHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        this.setupLights();
        this.setupControls();

        document.querySelectorAll('.model-item').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.model-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.loadModel(btn.dataset.model);
                updateInfo(btn.dataset.model);
            });
        });

        this.loadModel("dorichescaya");
        updateInfo("dorichescaya");

        this.animate();
    }

    setupLights() {
        const hemi = new THREE.HemisphereLight(0xffffff, 0x222222, 0.55);
        const key  = new THREE.DirectionalLight(0xffffff, 1.35);
        const fill = new THREE.DirectionalLight(0xdde6ff, 0.55);
        const rim  = new THREE.DirectionalLight(0xffffff, 0.65);
        const amb  = new THREE.AmbientLight(0xffffff, 0.18);

        key.position.set(4, 8, 6);
        fill.position.set(-6, 4, 2);
        rim.position.set(-3, 6, -5);

        key.castShadow = true;
        key.shadow.mapSize.width = 2048;
        key.shadow.mapSize.height = 2048;

        this.scene.add(hemi, key, fill, rim, amb);
    }

    setupControls() {
        const canvas = document.getElementById("canvas");

        canvas.addEventListener("mousedown", e => {
            this.mouse.down = true;
            this.mouse.button = e.button;
            this.mouse.x = e.clientX;
            this.mouse.y = e.clientY;
        });

        canvas.addEventListener("mousemove", e => {
            if (!this.mouse.down) return;
            const dx = e.clientX - this.mouse.x;
            const dy = e.clientY - this.mouse.y;

            if (this.mouse.button === 0) {
                this.targetRotation.y += dx * -0.008;
                this.targetRotation.x += dy * 0.008;
            } else if (this.mouse.button === 2 && this.currentModel) {
                this.currentModel.position.x += dx * 0.01;
                this.currentModel.position.y -= dy * 0.01;
            }

            this.mouse.x = e.clientX;
            this.mouse.y = e.clientY;
        });

        window.addEventListener("mouseup", () => this.mouse.down = false);

        canvas.addEventListener("wheel", e => {
            e.preventDefault();
            this.cameraDistance += e.deltaY * 0.004;
            this.cameraDistance = Math.min(this.maxCameraDistance, Math.max(this.minCameraDistance, this.cameraDistance));
            this.updateCameraPosition();
        }, { passive:false });

        canvas.addEventListener("contextmenu", e => e.preventDefault());
    }

    updateCameraPosition() {
        const x = this.cameraDistance * Math.sin(this.rotation.y) * Math.cos(this.rotation.x);
        const y = this.cameraDistance * Math.sin(this.rotation.x);
        const z = this.cameraDistance * Math.cos(this.rotation.y) * Math.cos(this.rotation.x);
        this.camera.position.set(x, y, z);
        this.camera.lookAt(0, 0, 0);
    }

    applyMaterial(root) {
        const mat = new THREE.MeshStandardMaterial({
            color: 0xcfcfcf,
            roughness: 0.65,
            metalness: 0.0
        });

        root.traverse(c => {
            if (c.isMesh) {
                c.material = mat.clone();
                c.castShadow = true;
                c.receiveShadow = true;
            }
        });
    }

    loadModel(name) {
        document.getElementById("loading").style.display = "flex";
        document.getElementById("progressBar").style.width = "0%";

        if (this.currentModel) this.scene.remove(this.currentModel);

        const loader = new GLTFLoader();
        const url = modelUrls[name];

        loader.load(url, gltf => {
            const root = new THREE.Group();
            root.add(gltf.scene);

            const box = new THREE.Box3().setFromObject(root);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            gltf.scene.position.sub(center);

            const max = Math.max(size.x, size.y, size.z);
            const scale = 2 / max;
            root.scale.set(scale, scale, scale);

            this.cameraDistance = Math.max(2, max * scale * 1.6);

            this.applyMaterial(root);
            this.currentModel = root;
            this.scene.add(root);

            this.rotation = { x:0, y:0 };
            this.targetRotation = { x:0, y:0 };
            this.updateCameraPosition();

            document.getElementById("loading").style.display = "none";

        }, p => {
            if (p.lengthComputable) {
                const percent = (p.loaded / p.total) * 100;
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("loadingText").textContent = "Загрузка: " + percent.toFixed(0) + "%";
            }
        });
    }

    animate() {
        requestAnimationFrame(() => this.animate());

        this.rotation.x += (this.targetRotation.x - this.rotation.x) * 0.12;
        this.rotation.y += (this.targetRotation.y - this.rotation.y) * 0.12;

        const maxTilt = Math.PI/2 - 0.05;
        this.rotation.x = Math.max(-maxTilt, Math.min(maxTilt, this.rotation.x));

        this.updateCameraPosition();
        this.renderer.render(this.scene, this.camera);
    }
}

function updateInfo(name) {
    const i = modelInfo[name];
    document.getElementById("model-title").textContent = i.title;
    document.getElementById("model-style").textContent = i.style;
    document.getElementById("model-period").textContent = i.period;
    document.getElementById("model-description").textContent = i.description;
}

new ModelViewer();

window.addEventListener("resize", () => {
    const viewer = document.getElementById("viewer");
    viewer.viewerCamera.aspect = viewer.clientWidth / viewer.clientHeight;
});

</script>

</body>
</html>
