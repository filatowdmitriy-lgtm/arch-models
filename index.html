<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Architectural Models Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            background: #111;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
        }

        /* --- GALLERY --- */
        #gallery {
            width: 100%;
            height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .model-card {
            background: #222;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #333;
            cursor: pointer;
            transition: 0.15s;
        }

        .model-card:hover {
            background: #333;
        }

        /* --- VIEWER --- */
        #viewer {
            width: 100%;
            height: 100vh;
            display: none;  /* скрыт по умолчанию */
            position: relative;
        }

        #backButton {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            background: rgba(0,0,0,0.55);
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        #backButton:hover {
            background: rgba(255,255,255,0.15);
        }

        #canvasContainer {
            width: 100%;
            height: 100%;
        }

        /* Лоадер */
        #loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: white;
            position: absolute;
            bottom: 20px;
            width: 100%;
        }

        #progressBar {
            width: 0%;
            height: 3px;
            background: #4caf50;
            margin-top: 5px;
            transition: width 0.15s;
        }

    </style>
</head>

<body>

<!-- ============================= -->
<!--        GALLERY SCREEN         -->
<!-- ============================= -->
<div id="gallery">

    <h2 style="text-align:center; margin-bottom:10px;">Выберите модель</h2>

    <div class="model-card" onclick="openModel('dorichescaya')">
        Дорическая капитель
    </div>

    <div class="model-card" onclick="openModel('ionic')">
        Ионическая капитель
    </div>

</div>



<!-- ============================= -->
<!--         VIEWER SCREEN         -->
<!-- ============================= -->
<div id="viewer">

    <button id="backButton" onclick="showGallery()">← Назад</button>

    <div id="canvasContainer"></div>

    <div id="loading">
        <div id="loadingText">Загрузка...</div>
        <div id="progressBar"></div>
    </div>
</div>




<!-- ============================= -->
<!--         THREE.JS & APP        -->
<!-- ============================= -->

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.module.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.153.0/examples/jsm/loaders/GLTFLoader.js";



/* ---------------------------------------
          МАРШРУТИЗАЦИЯ ЭКРАНОВ
----------------------------------------*/
function showGallery() {
    document.getElementById("viewer").style.display = "none";
    document.getElementById("gallery").style.display = "flex";

    // остановить рендер текущей модели
    if (window.app) {
        window.app.dispose();
        window.app = null;
    }
}

function showViewer() {
    document.getElementById("gallery").style.display = "none";
    document.getElementById("viewer").style.display = "block";
}


/* ---------------------------------------
        ОТКРЫТИЕ МОДЕЛИ ИЗ ГАЛЕРЕИ
----------------------------------------*/
function openModel(modelName) {
    showViewer();

    // Если приложение уже есть — удалить, чтобы не дублировалось
    if (window.app) {
        window.app.dispose();
        window.app = null;
    }

    window.app = new ModelViewer("canvasContainer");
    window.app.loadModel(modelName);
}

window.openModel = openModel;
window.showGallery = showGallery;




/* ---------------------------------------
           ТВОЙ КЛАСС ModelViewer
       (взял без изменений из v5)
----------------------------------------*/

class ModelViewer {
    constructor(containerId) {

        this.container = document.getElementById(containerId);
        this.width = this.container.clientWidth;
        this.height = this.container.clientHeight;

        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, this.width / this.height, 0.1, 100);
        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(this.width, this.height);
        this.container.appendChild(this.renderer.domElement);

        // Свет оставляем как был
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
        this.scene.add(hemi);

        const dir = new THREE.DirectionalLight(0xffffff, 0.9);
        dir.position.set(5, 10, 7);
        this.scene.add(dir);

        this.currentModel = null;
        this.cache = {};

        this.mouse = { x: 0, y: 0, down: false };
        this.rotation = { x: 0, y: 0 };
        this.targetRotation = { x: 0, y: 0 };

        this.cameraDistance = 4;
        this.minCameraDistance = 1;
        this.maxCameraDistance = 12;

        this.addEvents();

        this.animate = this.animate.bind(this);
        requestAnimationFrame(this.animate);
    }


    dispose() {
        cancelAnimationFrame(this.animFrame);
        this.renderer.dispose();
        this.container.innerHTML = "";
    }


    addEvents() {
        this.renderer.domElement.addEventListener("mousedown", e => {
            this.mouse.down = true;
            this.mouse.x = e.clientX;
            this.mouse.y = e.clientY;
        });

        window.addEventListener("mouseup", () => this.mouse.down = false);

        window.addEventListener("mousemove", e => {
            if (!this.mouse.down) return;
            const dx = e.clientX - this.mouse.x;
            const dy = e.clientY - this.mouse.y;

            this.targetRotation.y += dx * 0.005;
            this.targetRotation.x += dy * 0.005;

            this.mouse.x = e.clientX;
            this.mouse.y = e.clientY;
        });

        // touch
        this.renderer.domElement.addEventListener("touchstart", e => {
            this.mouse.down = true;
            this.mouse.x = e.touches[0].clientX;
            this.mouse.y = e.touches[0].clientY;
        });

        this.renderer.domElement.addEventListener("touchend", () => this.mouse.down = false);

        this.renderer.domElement.addEventListener("touchmove", e => {
            if (!this.mouse.down) return;
            const dx = e.touches[0].clientX - this.mouse.x;
            const dy = e.touches[0].clientY - this.mouse.y;

            this.targetRotation.y += dx * 0.005;
            this.targetRotation.x += dy * 0.005;

            this.mouse.x = e.touches[0].clientX;
            this.mouse.y = e.touches[0].clientY;
        });

        // zoom
        window.addEventListener("wheel", e => {
            this.cameraDistance += e.deltaY * 0.003;
            this.cameraDistance = Math.max(this.minCameraDistance, Math.min(this.maxCameraDistance, this.cameraDistance));
        });
    }


    updateCameraPosition() {
        this.camera.position.set(
            Math.sin(this.rotation.y) * this.cameraDistance,
            Math.sin(this.rotation.x) * this.cameraDistance,
            Math.cos(this.rotation.y) * this.cameraDistance
        );
        this.camera.lookAt(0, 0, 0);
    }


    applyMaterial(root) {
        root.traverse(obj => {
            if (obj.isMesh) {
                obj.material = new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    roughness: 0.95,
                    metalness: 0.0
                });
            }
        });
    }


    setModel(root) {
        if (this.currentModel) {
            this.scene.remove(this.currentModel);
        }
        this.currentModel = root;
        this.scene.add(this.currentModel);

        this.rotation = { x: 0, y: 0 };
        this.targetRotation = { x: 0, y: 0 };
        this.updateCameraPosition();

        document.getElementById("loading").style.display = "none";
    }


    loadModel(modelName) {

        console.log("Загрузка модели:", modelName);
        document.getElementById("loading").style.display = "block";

        if (this.currentModel) {
            this.scene.remove(this.currentModel);
            this.currentModel = null;
        }

        if (this.cache[modelName]) {
            const copy = this.cache[modelName].clone(true);
            this.setModel(copy);
            return;
        }

        const loader = new GLTFLoader();
        const url = {
            dorichescaya: "https://filatowdmitriy-lgtm.github.io/arch-models/dorichescaya.glb",
            ionic: "https://filatowdmitriy-lgtm.github.io/arch-models/ionic.glb"
        }[modelName];

        loader.load(url, gltf => {

            const root = new THREE.Group();
            root.add(gltf.scene);

            const box = new THREE.Box3().setFromObject(root);
            const c = box.getCenter(new THREE.Vector3());
            const s = box.getSize(new THREE.Vector3());

            gltf.scene.position.sub(c);

            const maxSize = Math.max(s.x, s.y, s.z);
            const scale = 2.0 / maxSize;

            root.scale.setScalar(scale);

            this.cameraDistance = Math.max(2, maxSize * scale * 1.6);
            this.minCameraDistance = Math.max(1.2, maxSize * scale * 0.9);
            this.maxCameraDistance = Math.max(6, maxSize * scale * 6);

            this.applyMaterial(root);

            this.cache[modelName] = root.clone(true);

            this.setModel(root);

        }, prog => {
            if (prog.lengthComputable) {
                const pct = (prog.loaded / prog.total) * 100;
                document.getElementById("loadingText").innerText = "Загрузка: " + pct.toFixed(0) + "%";
                document.getElementById("progressBar").style.width = pct + "%";
            }
        },
            err => {
                console.error("Ошибка загрузки", err);
                document.getElementById("loading").style.display = "none";
            }
        );
    }


    animate() {
        this.animFrame = requestAnimationFrame(this.animate);

        this.rotation.x += (this.targetRotation.x - this.rotation.x) * 0.07;
        this.rotation.y += (this.targetRotation.y - this.rotation.y) * 0.07;

        this.updateCameraPosition();
        this.renderer.render(this.scene, this.camera);
    }
}

</script>

</body>
</html>
